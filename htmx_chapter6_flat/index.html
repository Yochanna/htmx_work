<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HTMX — Chapter 6: Triggers & Events (Single File)</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#38bdf8;--ok:#22c55e;--warn:#f59e0b;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    a{color:var(--accent);text-decoration:none}
    h1,h2,h3{margin:0 0 .5rem}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.row{grid-template-columns:1.1fr .9fr}}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#1f2937;color:#cbd5e1;margin-right:.4rem;border:1px solid #374151;cursor:pointer;user-select:none}
    .pill.active{outline:2px solid var(--accent)}
    .input{width:100%;padding:.6rem .8rem;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--ink)}
    .btn{padding:.6rem .9rem;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--ink);cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;background:#0b1220;padding:.5rem .6rem;border-radius:10px;border:1px solid #374151;overflow:auto}
    .tag{font-size:.75rem;padding:.15rem .45rem;border-radius:8px;background:#0b1220;border:1px solid #374151;color:#93c5fd}
    .small{font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HTMX — Chapter 6: Triggers &amp; Events</h1>
    <p class="muted">Single-page demos powered by a Service Worker (so everything works from one <code>index.html</code>). Start a simple local server and you're good to go.</p>

    <!-- Teaching Overview -->
    <div class="card">
      <h2>Teaching: What you'll learn</h2>
      <ul>
        <li><span class="tag">hx-trigger</span> basics: <em>changed</em>, <em>keyup delay</em>, <em>once</em>, <em>throttle</em>.</li>
        <li>Event sources: <span class="tag">from:</span> other elements and custom events.</li>
        <li>Including extra values with <span class="tag">hx-include</span> and <span class="tag">hx-vals</span>.</li>
        <li>Clean swaps with <span class="tag">hx-target</span> and <span class="tag">hx-swap</span>.</li>
      </ul>
      <p class="small muted">This page registers a Service Worker to respond to HTMX requests like <code>/api/suggest</code>, <code>/api/filter</code>, <code>/api/price</code>, and <code>/api/quote</code> — no backend setup needed.</p>
    </div>

    <!-- DEMO 1 -->
    <div class="card" id="demo1">
      <div class="row">
        <div>
          <h2>Demo 1 — Search-as-you-type (changed + delay)</h2>
          <p class="muted small">Uses <span class="tag">hx-get="/api/suggest"</span> with <span class="tag">hx-trigger="keyup changed delay:500ms"</span>. The Service Worker returns HTML suggestions.</p>
          <input id="q" class="input" type="text" name="q" placeholder="Type a topic (e.g., htmx)" 
                 hx-get="/api/suggest" hx-trigger="keyup changed delay:500ms" 
                 hx-target="#suggestions" hx-vals='{"limit": 5}' />
          <div id="suggestions" class="mono" style="margin-top:10px;min-height:60px">… waiting for input</div>
        </div>
        <div>
          <h3>Key Ideas</h3>
          <ul>
            <li><strong>changed</strong> fires when the value actually changes.</li>
            <li><strong>delay:500ms</strong> bundles quick keystrokes into one request.</li>
            <li><strong>hx-vals</strong> adds extra JSON values to the request.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- DEMO 2 -->
    <div class="card" id="demo2">
      <div class="row">
        <div>
          <h2>Demo 2 — Trigger from other elements (from: .chip)</h2>
          <p class="muted small">Clicking a chip fires the request on the hidden form via <span class="tag">from:.chip</span>. The selected filters are sent using <span class="tag">hx-include</span>.</p>
          <div id="chips">
            <span class="pill chip" data-tag="frontend">frontend</span>
            <span class="pill chip" data-tag="backend">backend</span>
            <span class="pill chip" data-tag="data">data</span>
            <span class="pill chip" data-tag="devops">devops</span>
          </div>

          <form id="filterForm">
            <input type="hidden" name="tags" id="tagsInput" value=""/>
            <div class="mono small" style="margin:.6rem 0">Selected: <span id="tagsLabel">none</span></div>
          </form>

          <button class="btn"
              hx-get="/api/filter"
              hx-trigger="click from:.chip"
              hx-include="#filterForm"
              hx-target="#filterResults"
              hx-swap="innerHTML">
            Load filtered items
          </button>

          <div id="filterResults" class="mono" style="margin-top:10px;min-height:80px">… click chips, then click button</div>
        </div>
        <div>
          <h3>Key Ideas</h3>
          <ul>
            <li><strong>from:.chip</strong> — trigger originates from another element.</li>
            <li><strong>hx-include</strong> includes form values without nesting.</li>
            <li>We toggle chip selection with a tiny script (no framework).</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- DEMO 3 -->
    <div class="card" id="demo3">
      <div class="row">
        <div>
          <h2>Demo 3 — Throttle & once</h2>
          <p class="muted small">Drag the slider. <span class="tag">throttle:600ms</span> limits requests; the button uses <span class="tag">once</span> to run a one-off init.</p>
          <input type="range" id="price" min="0" max="100" value="50" class="input"
                 hx-get="/api/price"
                 hx-trigger="input throttle:600ms"
                 hx-target="#priceOut" />
          <div id="priceOut" class="mono" style="margin-top:10px;min-height:40px">Current value: 50 → total = R 750</div>

          <button class="btn" 
                  hx-get="/api/price?init=true&value=50"
                  hx-trigger="click once"
                  hx-target="#priceOut">
            Initialize Pricing (once)
          </button>
        </div>
        <div>
          <h3>Key Ideas</h3>
          <ul>
            <li><strong>throttle</strong> reduces server load during drag.</li>
            <li><strong>once</strong> runs exactly one time on this element.</li>
            <li>Server computes a simple total from the slider value.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- DEMO 4 -->
    <div class="card" id="demo4">
      <div class="row">
        <div>
          <h2>Demo 4 — Custom events</h2>
          <p class="muted small">We dispatch a custom <code>refresh</code> event. The panel listens with <span class="tag">hx-trigger="refresh from:body"</span> and fetches a quote.</p>
          <div class="grid" style="align-items:start">
            <button class="btn" id="refreshBtn">Dispatch <code>refresh</code></button>
            <div id="quote"
                 hx-get="/api/quote"
                 hx-trigger="refresh from:body"
                 class="mono" style="min-height:60px">Click the button → custom event → HTMX request</div>
          </div>
        </div>
        <div>
          <h3>Key Ideas</h3>
          <ul>
            <li>Custom DOM events can trigger HTMX requests.</li>
            <li><strong>from:body</strong> scopes where the event is listened from.</li>
            <li>Great for cross-component refreshes.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Try-Its -->
    <div class="card">
      <h2>Try‑Its</h2>
      <ol>
        <li><strong>Demo 1:</strong> Change delay to <code>250ms</code> and observe requests. Add <code>hx-indicator="#spin1"</code> and a spinner element.</li>
        <li><strong>Demo 2:</strong> Add a chip <code>ai</code>; ensure it toggles and filters.</li>
        <li><strong>Demo 3:</strong> Replace <code>throttle</code> with <code>delay:800ms</code>. What changes?</li>
        <li><strong>Demo 4:</strong> Listen for <code>refresh</code> on <code>#demo4</code> only (<code>from:#demo4</code>) and compare behavior.</li>
      </ol>
    </div>

    <!-- Service Worker registration (inline via Blob) -->
    <script>
      // Simple state for Demo 2 chip selection
      const chipsEl = document.getElementById('chips');
      const tagsInput = document.getElementById('tagsInput');
      const tagsLabel = document.getElementById('tagsLabel');
      if (chipsEl) {
        chipsEl.addEventListener('click', (e) => {
          const chip = e.target.closest('.chip');
          if (!chip) return;
          chip.classList.toggle('active');
          const selected = [...document.querySelectorAll('.chip.active')].map(c => c.dataset.tag);
          tagsInput.value = selected.join(',');
          tagsLabel.textContent = selected.length ? selected.join(', ') : 'none';
        });
      }

      // Custom event for Demo 4
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          const evt = new CustomEvent('refresh', {bubbles:true});
          document.body.dispatchEvent(evt);
        });
      }

      // Service Worker code as a string
      const swCode = `
        const html = (s) => new Response(s, {headers:{'Content-Type':'text/html; charset=utf-8'}});
        const rnd = (n) => Math.floor(Math.random()*n);
        const QUOTES = [
          'Simplicity is the soul of efficiency. — Austin Freeman',
          'Programs must be written for people to read. — Harold Abelson',
          'Small steps lead to big results.',
          'Progress over perfection.',
          'Ship early, learn fast.'
        ];

        function parseQuery(url) {
          const u = new URL(url);
          const out = Object.fromEntries(u.searchParams.entries());
          return out;
        }

        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('activate', e => self.clients.claim());

        self.addEventListener('fetch', (event) => {
          const url = new URL(event.request.url);
          if (url.pathname === '/api/suggest') {
            event.respondWith(handleSuggest(url));
          } else if (url.pathname === '/api/filter') {
            event.respondWith(handleFilter(event.request));
          } else if (url.pathname === '/api/price') {
            event.respondWith(handlePrice(url));
          } else if (url.pathname === '/api/quote') {
            event.respondWith(handleQuote());
          }
        });

        async function handleSuggest(url) {
          const q = url.searchParams.get('q')?.trim() ?? '';
          const limit = parseInt(url.searchParams.get('limit') || '5', 10);
          if (!q) return html('<em>Type to see suggestions…</em>');
          const base = ['htmx','hyperscript','django','flask','alpine','tailwind','dom','events','triggers','swap','target','include','ajax','json','partial'];
          const filtered = base.filter(x => x.includes(q.toLowerCase())).slice(0, limit);
          const list = filtered.length ? filtered.map(s => \`<li>\${s}</li>\`).join('') : '<li><em>No matches</em></li>';
          return html(\`<strong>Suggestions for "\${q}"</strong><ul>\${list}</ul>\`);
        }

        async function handleFilter(req) {
          const body = await req.formData();
          const tags = (body.get('tags') || '').split(',').filter(Boolean);
          const items = [
            {name:'Build a Nav Bar', tag:'frontend'},
            {name:'REST Endpoint', tag:'backend'},
            {name:'SQL Basics', tag:'data'},
            {name:'Pipelines 101', tag:'devops'},
            {name:'HTMX Partials', tag:'frontend'},
            {name:'ORM Patterns', tag:'backend'},
            {name:'Pandas Intro', tag:'data'},
            {name:'Containerize App', tag:'devops'}
          ];
          const filtered = tags.length ? items.filter(i => tags.includes(i.tag)) : items;
          const htmlStr = filtered.map(i => \`<div>• \${i.name} <span class="tag">\${i.tag}</span></div>\`).join('') || '<em>No items match</em>';
          return html(htmlStr);
        }

        async function handlePrice(url) {
          const value = parseInt(url.searchParams.get('value') || url.searchParams.get('price') || '50', 10);
          const init = url.searchParams.get('init') === 'true';
          const total = Math.round(value * 15); // simple ZAR-ish multiplier
          const msg = init ? '(initialized) ' : '';
          return html(\`Current value: \${value} → \${msg}total = R \${total}\`);
        }

        async function handleQuote() {
          const q = QUOTES[rnd(QUOTES.length)];
          return html(\`<div>📝 \${q}</div>\`);
        }
      `;

      // Register the Service Worker via a Blob URL so we keep a single file
      if ('serviceWorker' in navigator) {
        const blob = new Blob([swCode], {type:'text/javascript'});
        const swURL = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swURL).catch(err => console.error('SW register failed', err));
      } else {
        console.warn('Service Worker not supported in this browser.');
      }
    </script>
  </div>
</body>
</html>
